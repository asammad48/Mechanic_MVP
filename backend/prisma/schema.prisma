datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model Branch {
  id        Int      @id @default(autoincrement())
  name      String
  code      String   @unique
  address   String?
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  customers Customer[]
  vehicles  Vehicle[]
  visits    Visit[]
  visitEvents VisitEvent[]
}

model Role {
  id    Int @id @default(autoincrement())
  name  String @unique
  users User[]
}

model User {
  id            Int      @id @default(autoincrement())
  name          String
  email         String      @unique
  password_hash String
  isSuperAdmin  Boolean     @default(false)

  role    Role   @relation(fields: [roleId], references: [id])
  roleId  Int

  branch   Branch? @relation(fields: [branchId], references: [id])
  branchId Int?

  createdAt DateTime @default(now())

  createdVisits    Visit[]      @relation("CreatedBy")
  assignedVisits   Visit[]      @relation("AssignedTo")
  notes            VisitNote[]
  voidedPayments   Payment[]    @relation("VoidedBy")
  deletedLaborItems LaborItem[] @relation("DeletedByLabor")
  deletedPartItems  PartItem[]  @relation("DeletedByPart")
  visitEvents      VisitEvent[]
}

model Customer {
  id      Int      @id @default(autoincrement())
  name    String
  phone   String
  address String?

  branch   Branch @relation(fields: [branchId], references: [id])
  branchId Int

  createdAt DateTime @default(now())

  vehicles Vehicle[]
  visits   Visit[]

  @@unique([phone, branchId])
  @@index([branchId, phone])
}

model Vehicle {
  id      Int @id @default(autoincrement())
  regNo   String
  make    String
  model   String
  year    Int
  color   String?
  vin     String?  @unique
  mileage Int?

  customer   Customer @relation(fields: [customerId], references: [id])
  customerId Int

  branch   Branch @relation(fields: [branchId], references: [id])
  branchId Int

  visits Visit[]

  @@unique([regNo, branchId])
  @@index([branchId, regNo])
}

model Visit {
  id                Int    @id @default(autoincrement())
  status            String    @default("CREATED") // CREATED, IN_PROGRESS, WAITING_PARTS, READY, DELIVERED, CANCELLED
  complaint         String
  mileage           Int
  priority          String?   // LOW, MEDIUM, HIGH
  expectedDelivery  DateTime?

  subtotalLabor   Decimal @default(0)
  subtotalParts   Decimal @default(0)
  subtotalOutside Decimal @default(0)
  discountAmount  Decimal @default(0)
  discountType    String @default("FLAT") // FLAT, PERCENTAGE
  taxRate         Decimal @default(0)
  taxAmount       Decimal @default(0)
  grandTotal      Decimal @default(0)

  paymentStatus String @default("UNPAID") // UNPAID, PARTIAL, PAID
  paidAmount    Decimal @default(0)
  dueAmount     Decimal @default(0)

  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])
  vehicleId Int

  customer   Customer @relation(fields: [customerId], references: [id])
  customerId Int

  branch   Branch @relation(fields: [branchId], references: [id])
  branchId Int

  assignedMechanic    User?    @relation("AssignedTo", fields: [assignedMechanicId], references: [id])
  assignedMechanicId  Int?

  createdBy          User     @relation("CreatedBy", fields: [createdByUserId], references: [id])
  createdByUserId    Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  laborItems    LaborItem[]
  partItems     PartItem[]
  outsideItems  OutsideWorkItem[]
  payments      Payment[]
  notes         VisitNote[]
  events        VisitEvent[]

  @@index([branchId, createdAt])
  @@index([branchId, status])
}

model LaborItem {
  id        Int      @id @default(autoincrement())
  title     String
  hours     Decimal
  ratePerHour Decimal
  subtotal  Decimal

  visit    Visit  @relation(fields: [visitId], references: [id])
  visitId  Int

  deletedAt       DateTime?
  deletedBy       User?     @relation("DeletedByLabor", fields: [deletedByUserId], references: [id])
  deletedByUserId Int?
}

model PartItem {
  id         Int      @id @default(autoincrement())
  name       String
  qty        Int
  unitPrice  Decimal
  subtotal   Decimal

  visit    Visit  @relation(fields: [visitId], references: [id])
  visitId  Int

  deletedAt       DateTime?
  deletedBy       User?     @relation("DeletedByPart", fields: [deletedByUserId], references: [id])
  deletedByUserId Int?
}

model OutsideWorkItem {
  id              Int      @id @default(autoincrement())
  vendorName      String
  workDescription String
  cost            Decimal
  notes           String?
  createdAt       DateTime @default(now())

  visit    Visit  @relation(fields: [visitId], references: [id])
  visitId  Int
}

model Payment {
  id          Int      @id @default(autoincrement())
  paidAmount  Decimal
  method      String?  // CASH, CARD, TRANSFER
  paidAt      DateTime @default(now())

  visit    Visit @relation(fields: [visitId], references: [id])
  visitId  Int

  isVoided        Boolean   @default(false)
  voidReason      String?
  voidedAt        DateTime?
  voidedBy        User?     @relation("VoidedBy", fields: [voidedByUserId], references: [id])
  voidedByUserId  Int?
}

model VisitNote {
  id        Int      @id @default(autoincrement())
  note      String

  visit    Visit @relation(fields: [visitId], references: [id])
  visitId  Int

  createdBy      User     @relation(fields: [createdByUserId], references: [id])
  createdByUserId Int

  createdAt DateTime @default(now())
}

model VisitEvent {
  id        Int      @id @default(autoincrement())
  type      String   // E.g., 'STATUS_CHANGE', 'PAYMENT_VOIDED', 'MECHANIC_ASSIGNED'
  payloadJson String?

  visit    Visit @relation(fields: [visitId], references: [id])
  visitId  Int

  branch   Branch @relation(fields: [branchId], references: [id])
  branchId Int

  createdBy      User     @relation(fields: [createdByUserId], references: [id])
  createdByUserId Int

  createdAt DateTime @default(now())
}