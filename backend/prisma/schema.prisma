datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model Branch {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  address   String?
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  customers Customer[]
  vehicles  Vehicle[]
  visits    Visit[]
  visitEvents VisitEvent[]
}

model Role {
  id    String @id @default(cuid())
  name  String @unique
  users User[]
}

model User {
  id            String      @id @default(cuid())
  name          String
  email         String      @unique
  password_hash String
  isSuperAdmin  Boolean     @default(false)

  role    Role   @relation(fields: [roleId], references: [id])
  roleId  String

  branch   Branch? @relation(fields: [branchId], references: [id])
  branchId String?

  createdAt DateTime @default(now())

  createdVisits    Visit[]      @relation("CreatedBy")
  assignedVisits   Visit[]      @relation("AssignedTo")
  notes            VisitNote[]
  voidedPayments   Payment[]    @relation("VoidedBy")
  deletedLaborItems LaborItem[] @relation("DeletedByLabor")
  deletedPartItems  PartItem[]  @relation("DeletedByPart")
  visitEvents      VisitEvent[]
}

model Customer {
  id      String   @id @default(cuid())
  name    String
  phone   String
  address String?

  branch   Branch @relation(fields: [branchId], references: [id])
  branchId String

  createdAt DateTime @default(now())

  vehicles Vehicle[]
  visits   Visit[]

  @@unique([phone, branchId])
  @@index([branchId, phone])
}

model Vehicle {
  id      String @id @default(cuid())
  regNo   String
  make    String
  model   String
  year    Int
  color   String?
  vin     String?  @unique
  mileage Int?

  customer   Customer @relation(fields: [customerId], references: [id])
  customerId String

  branch   Branch @relation(fields: [branchId], references: [id])
  branchId String

  visits Visit[]

  @@unique([regNo, branchId])
  @@index([branchId, regNo])
}

model Visit {
  id                String    @id @default(cuid())
  status            String    @default("CREATED") // CREATED, IN_PROGRESS, WAITING_PARTS, READY, DELIVERED, CANCELLED
  complaint         String
  mileage           Int
  priority          String?   // LOW, MEDIUM, HIGH
  expectedDelivery  DateTime?

  subtotalLabor   Float @default(0)
  subtotalParts   Float @default(0)
  subtotalOutside Float @default(0)
  discountAmount  Float @default(0)
  discountType    String @default("FLAT") // FLAT, PERCENTAGE
  taxRate         Float @default(0)
  taxAmount       Float @default(0)
  grandTotal      Float @default(0)

  paymentStatus String @default("UNPAID") // UNPAID, PARTIAL, PAID
  paidAmount    Float @default(0)
  dueAmount     Float @default(0)

  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])
  vehicleId String

  customer   Customer @relation(fields: [customerId], references: [id])
  customerId String

  branch   Branch @relation(fields: [branchId], references: [id])
  branchId String

  assignedMechanic    User?    @relation("AssignedTo", fields: [assignedMechanicId], references: [id])
  assignedMechanicId  String?

  createdBy          User     @relation("CreatedBy", fields: [createdByUserId], references: [id])
  createdByUserId    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  laborItems LaborItem[]
  partItems  PartItem[]
  outsideWorkItems OutsideWorkItem[]
  payments   Payment[]
  notes      VisitNote[]
  events     VisitEvent[]

  @@index([branchId, createdAt])
  @@index([branchId, status])
}

model LaborItem {
  id        String   @id @default(cuid())
  title     String
  hours     Float
  ratePerHour Float
  subtotal  Float

  visit    Visit  @relation(fields: [visitId], references: [id])
  visitId  String

  deletedAt       DateTime?
  deletedBy       User?     @relation("DeletedByLabor", fields: [deletedByUserId], references: [id])
  deletedByUserId String?
}

model PartItem {
  id         String   @id @default(cuid())
  name       String
  qty        Int
  unitPrice  Float
  subtotal   Float

  visit    Visit  @relation(fields: [visitId], references: [id])
  visitId  String

  deletedAt       DateTime?
  deletedBy       User?     @relation("DeletedByPart", fields: [deletedByUserId], references: [id])
  deletedByUserId String?
}

model OutsideWorkItem {
  id              String   @id @default(cuid())
  vendorName      String
  workDescription String
  cost            Float
  notes           String?

  visit    Visit  @relation(fields: [visitId], references: [id])
  visitId  String

  createdAt DateTime @default(now())
}

model Payment {
  id          String   @id @default(cuid())
  paidAmount  Float
  method      String?  // CASH, CARD, TRANSFER
  paidAt      DateTime @default(now())

  visit    Visit @relation(fields: [visitId], references: [id])
  visitId  String

  isVoided        Boolean   @default(false)
  voidReason      String?
  voidedAt        DateTime?
  voidedBy        User?     @relation("VoidedBy", fields: [voidedByUserId], references: [id])
  voidedByUserId  String?
}

model VisitNote {
  id        String   @id @default(cuid())
  note      String

  visit    Visit @relation(fields: [visitId], references: [id])
  visitId  String

  createdBy      User     @relation(fields: [createdByUserId], references: [id])
  createdByUserId String

  createdAt DateTime @default(now())
}

model VisitEvent {
  id        String   @id @default(cuid())
  type      String   // E.g., 'STATUS_CHANGE', 'PAYMENT_VOIDED', 'MECHANIC_ASSIGNED'
  payloadJson String?

  visit    Visit @relation(fields: [visitId], references: [id])
  visitId  String

  branch   Branch @relation(fields: [branchId], references: [id])
  branchId String

  createdBy      User     @relation(fields: [createdByUserId], references: [id])
  createdByUserId String

  createdAt DateTime @default(now())
}
